# CI/CD 流水线 - 持续集成
# 触发条件：推送到 main/master 或 PR
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  ci:
    name: CI Pipeline
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install moon
        uses: moonrepo/setup-toolchain@v0
        with:
          auto-install: true

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Run CI (Lint, Typecheck, Test)
        run: moon ci
        env:
          DATABASE_MODE: sqlite
          DATABASE_URL: sqlite:///./test.db
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}

      - name: Docker Build Check (Backend)
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: apps/server
          file: apps/server/Dockerfile
          push: false
          tags: stock-agents-server:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Docker Build Check (Frontend)
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: apps/client
          file: apps/client/Dockerfile
          push: false
          tags: stock-agents-client:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
