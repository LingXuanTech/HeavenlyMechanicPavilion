# 下一步开发计划

> 生成时间: 2026-02-09
> 基于实际代码审查 + 需求文档 + 技术债务分析制定

---

## 一、当前状态总结

### 已完成（功能完整度 ~95%）

| 维度 | 状态 | 详情 |
|------|------|------|
| 后端路由 | ✅ 39 个路由，4 模块化子包 | market/analysis/trading/system 全部实现 |
| 后端服务 | ✅ ~38 个服务模块 | 核心业务逻辑完整 |
| AI Agent | ✅ 18 个 Agent | 分析师/辩论/风控/交易全链路 |
| 前端页面 | ✅ 14 个页面 | 全部完整实现，无骨架/占位符 |
| 前端组件 | ✅ 39 个组件 | 全部完整实现 |
| 前端 Hooks | ✅ 23 个 hooks | 全部完整实现 |
| API 集成 | ✅ 60+ 个 API 调用 | 前后端完全对接 |
| 认证系统 | ✅ JWT + OAuth + Passkey | 三重认证完整 |
| 类型系统 | ✅ OpenAPI 自动生成 | 前后端类型同步 |
| 数据库 | ✅ 13 个 SQLModel 模型 + Alembic | 迁移支持完整 |
| CI/CD | ✅ 4 个 GitHub Actions workflow | ci/backend-ci/frontend-ci/docker-build |
| 测试 | 🟡 30 个单元测试 + 3 个集成测试 | 覆盖核心路径，边界不足 |

### 残留技术债务（代码中的 TODO/FIXME）

| 问题 | 位置 | 严重程度 |
|------|------|----------|
| Vision 分析历史未持久化 | `vision_service.py:263` — `get_analysis_history()` 返回空列表 | 中 |
| 分析任务缺少用户关联 | `analyze.py:433,448` — `user_id=None # TODO` | 中 |
| 板块资金流向历史未实现 | `north_money_service.py:847` — 返回空 dict | 低 |
| `packages/` 共享包为空壳 | `packages/backend/`, `packages/frontend/` | 低 |
| SubGraph 架构默认关闭 | `use_subgraphs=False`，标记为实验性 | 中 |
| 集成测试 SSE 部分不完整 | `test_analyze_api.py` | 中 |
| cache_service 中的 asyncio.Lock hack | `cache_service.py:276` | 低 |

---

## 二、开发计划总览

基于 **业务价值 × 技术风险** 矩阵，分为 4 个阶段：

```
阶段 1 (Week 1-2)  → 工程质量加固 + 技术债务清理
阶段 2 (Week 3-4)  → 核心体验升级 + 数据层完善
阶段 3 (Week 5-7)  → 深度投研能力扩展
阶段 4 (Week 8-10) → 自动化闭环 + 智能推送
```

---

## 阶段 1：工程质量加固（Week 1-2）

> **目标**：消除技术债务，建立质量基线，确保后续迭代可持续

### 1.1 测试覆盖率提升 🔴 P0

**现状**：30 个单元测试 + 3 个集成测试，缺少 SSE 流测试和前端 E2E 测试

**任务**：

| 任务 | 文件 | 预估 |
|------|------|------|
| 补全 SSE 流集成测试 | `tests/integration/test_analyze_api.py` | 1d |
| 补全认证流程集成测试 | `tests/integration/test_auth_api.py` | 0.5d |
| 添加 synthesizer 边界测试 | `tests/unit/test_synthesizer.py` | 0.5d |
| 添加 accuracy_tracker 测试 | `tests/unit/test_accuracy_tracker.py` | 0.5d |
| 添加 backtest_service 测试 | `tests/unit/test_backtest_service.py` | 0.5d |
| 前端 E2E 测试框架搭建 (Playwright) | `apps/client/e2e/` | 1d |
| E2E 核心流程：登录 → 添加自选 → 触发分析 → 查看结果 | `apps/client/e2e/analysis-flow.spec.ts` | 1d |

**验收标准**：
- 后端测试覆盖率 > 70%（`pytest --cov`）
- 前端 E2E 覆盖核心分析流程
- CI 中集成 E2E 测试

### 1.2 技术债务清理 🔴 P0

| 任务 | 详情 | 预估 |
|------|------|------|
| 修复分析任务用户关联 | `analyze.py:433,448` — 从 JWT token 中提取 `user_id` 注入分析任务 | 0.5d |
| 实现 Vision 分析历史持久化 | 新增 `VisionAnalysis` 数据库模型，替换 `vision_service.py:263` 的空列表 | 1d |
| 清理 `packages/` 空壳目录 | 移除空目录，更新 `.moon/workspace.yml` | 0.5h |
| 统一 data_router 缓存到 cache_service | 将 `data_router.py` 模块级内存缓存迁移到统一缓存层 | 0.5d |

### 1.3 OpenAPI 类型同步自动化 🟡 P1

**现状**：`npm run gen:types` 需手动执行，CI 中未集成类型一致性检查

**任务**：
- 在 `frontend-ci.yml` 中添加 `npm run gen:types -- --check` 步骤
- 确保 PR 中后端 schema 变更时自动检测前端类型是否过期
- 预估：0.5d

---

## 阶段 2：核心体验升级 + 数据层完善（Week 3-4）

> **目标**：提升用户可感知的核心体验，补齐数据层短板

### 2.1 SubGraph 架构生产化 🟡 P1

**现状**：SubGraph 架构已实现但默认关闭（`use_subgraphs=False`），灰度发布机制已有 `rollout_manager.py`

**任务**：

| 任务 | 详情 | 预估 |
|------|------|------|
| SubGraph vs 传统模式 A/B 对比测试 | 对同一组 symbol 分别运行两种模式，对比结果一致性和性能 | 2d |
| 灰度比例逐步提升 | 10% → 30% → 50% → 100%，每阶段收集指标 | 1w（持续观察） |
| 默认启用评估 | 基于灰度数据决策是否将 `use_subgraphs` 默认改为 `True` | 决策点 |

### 2.2 北向资金数据完善 🟡 P1

**现状**：核心功能完整，但板块资金流向历史（`get_sector_flow_history`）返回空数据

**任务**：

| 任务 | 详情 | 预估 |
|------|------|------|
| 实现板块资金流向历史 | 基于 AkShare 数据实现 `get_sector_flow_history()`，支持 5/10/20 日趋势 | 1d |
| 北向资金-指数相关性计算 | 实现真实的相关性计算（替换占位逻辑），支持沪深300/上证50/创业板指 | 1d |
| 历史数据持久化 | 设计 `NorthMoneyDailySnapshot` 模型，定时存储每日汇总 | 1d |

### 2.3 数据源健康可视化 🟢 P2

**现状**：`health_monitor.py` 已有基础健康检查，但缺少数据源级别的细粒度监控

**任务**：
- 在 `/api/health/report` 中增加各数据源（AkShare/yfinance/Alpha Vantage）的熔断状态、失败率、平均延迟
- 前端 HealthPage 增加数据源状态卡片
- 预估：1.5d

### 2.4 前端性能优化 🟢 P2

**现状**：基础优化完成（路由级懒加载），但大列表和 bundle size 可优化

**任务**：

| 任务 | 详情 | 预估 |
|------|------|------|
| Bundle 分析与优化 | `vite-plugin-visualizer` 分析，拆分大依赖（recharts/lightweight-charts） | 1d |
| 大列表虚拟滚动 | 龙虎榜、北向资金持仓等长列表引入 `@tanstack/react-virtual` | 1d |
| 图片/图表懒加载 | 非视口内的图表组件延迟初始化 | 0.5d |

---

## 阶段 3：深度投研能力扩展（Week 5-7）

> **目标**：扩展分析能力边界，构建差异化竞争力

### 3.1 多模态财报分析 🟡 P1

**现状**：Vision 分析基础框架已有（`vision_analyst.py` + `vision_service.py`），但仅支持单图分析

**任务**：

| 任务 | 详情 | 预估 |
|------|------|------|
| 财报图表批量识别 | 支持上传多张财报截图，自动提取关键指标（营收/利润/现金流趋势） | 2d |
| 电话会录音转录 + 语义分析 | 集成 Whisper API 转录 → LLM 提取管理层态度/关键信息 | 3d |
| 前端多模态上传增强 | VisionUpload 组件支持批量上传、音频上传、进度展示 | 1.5d |

### 3.2 产业链知识图谱增强 🟡 P2

**现状**：`supply_chain_service.py`（550 行）+ `SupplyChainPage` 已实现基础产业链图谱

**任务**：

| 任务 | 详情 | 预估 |
|------|------|------|
| 供应链冲击传导模拟 | 给定某节点事件（如芯片短缺），模拟对上下游的影响传导路径和幅度 | 2d |
| 产业链数据自动更新 | 定时从公开数据源（年报/公告）更新供应商-客户关系 | 2d |
| 前端交互式图谱增强 | 支持节点点击展开详情、路径高亮、影响范围可视化 | 1.5d |

### 3.3 机构级风控建模 🟢 P2

**现状**：风险评估依赖 Agent 定性分析，缺少量化风控模型

**任务**：

| 任务 | 详情 | 预估 |
|------|------|------|
| 蒙特卡洛模拟 | 基于历史波动率的投资组合 VaR/CVaR 计算 | 2d |
| 压力测试场景 | 预设场景（2008 金融危机、2020 疫情、利率骤升）下的组合表现模拟 | 1.5d |
| 前端风控仪表盘 | PortfolioPage 增加 VaR 曲线、压力测试结果展示 | 1.5d |

---

## 阶段 4：自动化闭环 + 智能推送（Week 8-10）

> **目标**：从分析到执行的闭环，提升用户粘性

### 4.1 智能推送系统 🟡 P1

**现状**：定时分析调度器已有（`scheduler.py`），但分析结果仅在 Web 端展示

**任务**：

| 任务 | 详情 | 预估 |
|------|------|------|
| 推送引擎设计 | 统一推送接口（`NotificationService`），支持多渠道注册 | 1d |
| Telegram Bot 集成 | 基于信号强度（STRONG_BUY/STRONG_SELL）自动推送分析摘要 | 2d |
| 微信推送（企业微信/Server酱） | 备选渠道，适配国内用户 | 1.5d |
| 推送策略配置 | 前端 SettingsPage 增加推送偏好（渠道、信号阈值、静默时段） | 1d |

### 4.2 模拟盘对接 🟢 P2

**现状**：分析产出交易建议（TradeSetup: 入场/止盈/止损），但无执行能力

**任务**：

| 任务 | 详情 | 预估 |
|------|------|------|
| ExecutionAgent 接口设计 | 抽象交易执行接口，支持模拟盘/实盘切换 | 1d |
| 纸上交易引擎 | 内置模拟交易引擎，记录虚拟持仓和盈亏 | 3d |
| 绩效追踪仪表盘 | 前端展示模拟交易记录、累计收益曲线、夏普比率 | 2d |

### 4.3 AI 播客生成 🔵 P3（探索性）

**现状**：TTS 服务已有（`tts_service.py`），支持 OpenAI/Edge TTS

**任务**：

| 任务 | 详情 | 预估 |
|------|------|------|
| 双人对话脚本生成 | LLM 将分析报告转化为主持人+分析师对话脚本 | 2d |
| 多音色 TTS 合成 | 不同角色使用不同音色，合成完整播客音频 | 1.5d |
| 前端播客播放器 | AudioBriefing 组件增强，支持章节跳转、倍速播放 | 1d |

---

## 三、优先级矩阵

```
                    业务价值高
                        │
     ┌──────────────────┼──────────────────┐
     │  ⭐ 优先实施      │  📋 规划实施      │
     │                  │                  │
     │  · 测试覆盖率提升  │  · 多模态财报分析  │
     │  · 技术债务清理    │  · 机构级风控建模  │
     │  · SubGraph 生产化 │  · 智能推送系统    │
     │  · 北向资金完善    │  · 模拟盘对接      │
     │                  │                  │
  复杂度低 ─────────────┼──────────────── 复杂度高
     │                  │                  │
     │  🔧 可选优化      │  🔮 择机实施      │
     │                  │                  │
     │  · 类型同步自动化  │  · 产业链图谱增强  │
     │  · 清理 packages/ │  · AI 播客生成    │
     │  · 前端性能优化    │  · 数字人视频      │
     │  · 数据源健康可视化 │                  │
     │                  │                  │
     └──────────────────┼──────────────────┘
                        │
                    业务价值低
```

---

## 四、时间线

```
Week 1  ┃ 1.1 测试覆盖率提升（SSE 集成测试 + E2E 框架 + 核心流程）
        ┃ 1.2 技术债务清理（user_id 关联 + Vision 持久化 + packages 清理）
        ┃
Week 2  ┃ 1.2 技术债务清理（缓存统一）
        ┃ 1.3 OpenAPI 类型同步自动化
        ┃ 2.1 SubGraph A/B 对比测试启动
        ┃
Week 3  ┃ 2.2 北向资金数据完善（板块流向 + 相关性 + 持久化）
        ┃ 2.3 数据源健康可视化
        ┃ 2.1 SubGraph 灰度观察（10% → 30%）
        ┃
Week 4  ┃ 2.4 前端性能优化（bundle + 虚拟滚动 + 懒加载）
        ┃ 2.1 SubGraph 灰度观察（30% → 50%）
        ┃ ── 阶段 2 完成，评审决策点 ──
        ┃
Week 5  ┃ 3.1 多模态财报分析（批量图表识别 + 前端增强）
        ┃
Week 6  ┃ 3.1 电话会录音转录 + 语义分析
        ┃ 3.2 产业链冲击传导模拟
        ┃
Week 7  ┃ 3.2 产业链数据自动更新 + 前端增强
        ┃ 3.3 机构级风控建模（蒙特卡洛 + 压力测试 + 前端）
        ┃ ── 阶段 3 完成，评审决策点 ──
        ┃
Week 8  ┃ 4.1 智能推送系统（引擎 + Telegram + 微信）
        ┃
Week 9  ┃ 4.1 推送策略配置前端
        ┃ 4.2 模拟盘对接（ExecutionAgent + 纸上交易引擎）
        ┃
Week 10 ┃ 4.2 绩效追踪仪表盘
        ┃ 4.3 AI 播客生成（探索性，视剩余时间决定）
        ┃ ── 全部完成，总结评审 ──
```

---

## 五、关键决策点

| 时机 | 决策 | 依据 |
|------|------|------|
| Week 2 | 是否移除 `packages/` 目录 | 评估是否有共享包需求 |
| Week 4 | SubGraph 是否默认启用 | 灰度期间的性能/质量指标对比 |
| Week 4 | 阶段 3 功能优先级调整 | 基于用户反馈和业务需求 |
| Week 7 | 阶段 4 范围确认 | 基于阶段 3 交付情况和资源 |
| Week 7 | 风控建模深度 | 蒙特卡洛是否满足需求，是否需要更复杂模型 |
| Week 10 | AI 播客是否继续投入 | 探索性结果评估 |

---

## 六、风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| AkShare 接口变更导致数据中断 | 北向资金/龙虎榜功能不可用 | 版本锁定 + 熔断降级 + 备用数据源 |
| SubGraph 灰度期间发现严重问题 | 分析质量下降 | 快速回滚机制（`rollout_manager` 已支持） |
| 电话会录音转录成本高 | 多模态分析成本不可控 | 设置每日配额 + 缓存转录结果 |
| Telegram/微信推送 API 限流 | 推送延迟或丢失 | 消息队列缓冲 + 批量发送 + 降级为邮件 |
| 蒙特卡洛模拟计算耗时 | 用户等待时间长 | 异步计算 + 结果缓存 + 预计算常用组合 |

---

## 七、新增依赖预估

### 阶段 1
- 前端：`@playwright/test`（E2E 测试）

### 阶段 2
- 前端：`@tanstack/react-virtual`（虚拟滚动）、`rollup-plugin-visualizer`（bundle 分析）

### 阶段 3
- 后端：`openai-whisper` 或 `openai` Whisper API（音频转录）、`scipy`（蒙特卡洛模拟）

### 阶段 4
- 后端：`python-telegram-bot`（Telegram 推送）、`requests`（企业微信 webhook）

---

## 八、与现有计划文档的关系

本计划基于以下文档制定，并做了以下调整：

| 现有文档 | 本计划的处理 |
|----------|-------------|
| `iteration-plan.md` | **迭代 1（Alembic + CI/CD）已完成**，本计划从迭代 2 继续，合并了迭代 2-7 的核心内容 |
| `next_steps.md` | Sprint 1 中的大部分任务已完成（政策映射、市场路由等），本计划聚焦剩余的测试和优化 |
| `full_feature_plan.md` | P2-P5 功能大部分已实现，本计划聚焦未完成的多模态分析和风控建模 |
| `next_development_plan.md` | Week 1-4 的前端 UX + Agent + A股适配已全部完成，本计划聚焦后续扩展 |
| `expansion_blueprint.md` | 25 个扩展方向中，P1 大部分已完成，本计划选取 P2-P3 中最高价值的方向 |

**核心差异**：现有计划文档编写时项目完成度约 60-70%，当前实际完成度已达 ~95%。本计划基于最新代码状态，跳过已完成项，聚焦真正的增量价值。
