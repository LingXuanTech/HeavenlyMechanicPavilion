# 下一步迭代开发计划（Sprint 2026-02）

> 制定日期: 2026-02-11
> 迭代周期: 2 周（10 个工作日）
> 目标: 从“功能完成”进入“稳定交付”阶段

---

## 一、迭代目标与范围

### 1.1 迭代目标

1. **合约稳定**：修复重复 API 定义，稳定 OpenAPI 输出。
2. **链路稳定**：提升 SSE 与任务队列模式的回归保障。
3. **运维稳定**：完善运行手册与发布检查，降低线上变更风险。
4. **数据可追溯**：补齐关键任务与用户上下文关联。

### 1.2 非目标（本迭代不做）

1. 大规模新增业务页面
2. 多模态能力大扩展
3. 执行交易对接（实盘/模拟盘）

---

## 二、工作分解（WBS）

## WP1：API 合约一致性（P0）

### 背景
`apps/server/api/routes/system/ai_config.py` 存在重复路由定义，影响 API 可维护性与自动化类型生成稳定性。

### 任务

1. 清理重复端点定义，统一响应模型与错误处理。
2. 重新导出 OpenAPI Schema 并核对差异。
3. 更新前端类型生成产物并修复潜在调用处类型漂移。

### 交付物

- 干净的 `ai_config` 路由实现
- 更新后的 `openapi.json`
- 前端生成类型文件无告警

### 验收标准

- 无重复路由
- `pnpm run gen:types -- --check` 通过
- 相关 API 用例回归通过

---

## WP2：SSE + 队列模式回归加固（P0）

### 背景
分析主链路是项目核心价值路径，需要覆盖 background 与 queue 双模式。

### 任务

1. 增补 `analyze` 相关集成测试：
   - 任务创建成功
   - SSE 正常流转
   - 异常任务错误事件
2. 补充队列模式测试：
   - enqueue / dequeue / ack / nack
   - retry 与 DLQ 路径
3. 增加最小 smoke 脚本用于本地发布前检查。

### 交付物

- 新增/增强测试文件
- 回归测试执行记录
- 简化 smoke check 文档条目

### 验收标准

- 关键链路自动化测试可重复执行
- background/queue 两种模式均可跑通

---

## WP3：OpenAPI 链路统一（P0）

### 背景
当前前端类型脚本默认地址与后端默认 OpenAPI 地址不一致，存在协作成本。

### 任务

1. 统一默认 OpenAPI URL（与 `main.py` 保持一致）。
2. 在前端 CI 固化 `gen:types --check` 结果判定。
3. 更新相关文档中的 API 地址示例。

### 交付物

- 类型脚本默认地址修正
- CI 规则一致
- 文档同步

### 验收标准

- 本地与 CI 的 schema 来源一致
- PR 中 API 变更能自动触发类型一致性检查

---

## WP4：任务审计与可追踪性（P1）

### 背景
分析任务存在用户上下文未完全落库的风险，影响审计与问题定位。

### 任务

1. 将分析任务与 `user_id` 关联下沉到任务生命周期。
2. 在查询接口补充必要审计字段（不泄露敏感信息）。
3. 更新权限与数据可见性边界说明。

### 交付物

- 用户关联任务链路
- 审计字段可查询
- 文档与测试补齐

### 验收标准

- 有登录上下文时，任务可追溯到用户
- 无登录上下文时，行为不回归

---

## WP5：发布与运维文档收敛（P1）

### 背景
当前文档更新后已基本对齐，需要形成发布前固定检查流程。

### 任务

1. 固化发布检查清单（lint/typecheck/test/build/schema）。
2. 补充队列模式故障排查 SOP（积压、消费者异常、DLQ）。
3. 统一容器名、端点地址、命令入口写法。

### 交付物

- 标准化 Runbook 与发布 checklist
- 运维故障排查模板

### 验收标准

- 新成员可按文档在 30 分钟内完成本地启动与健康检查
- 运维排障步骤可闭环

---

## 三、排期与里程碑

| 时间 | 里程碑 | 核心结果 |
|---|---|---|
| Day 1-2 | M1 合约清理 | WP1 启动并完成重复路由清理 |
| Day 3-4 | M2 类型链路 | WP3 完成，前后端 OpenAPI 链路一致 |
| Day 5-7 | M3 回归加固 | WP2 完成关键回归覆盖 |
| Day 8-9 | M4 审计能力 | WP4 完成任务用户关联 |
| Day 10 | M5 收口发布 | WP5 完成并准备发布 |

---

## 四、风险与应对

1. **路由清理引入兼容风险**
   - 应对：先补测试再改路由，保留向后兼容字段。
2. **队列模式测试不稳定**
   - 应对：隔离外部依赖，优先 mock Redis 层并增加重试断言。
3. **类型链路变更影响前端编译**
   - 应对：先生成类型再修调用，逐步合并。

---

## 五、验收（DoD）

满足以下全部条件视为迭代完成：

1. `moon run :lint` 通过
2. `moon run :typecheck` 通过
3. `moon run :test` 通过
4. OpenAPI 类型校验通过（本地 + CI）
5. Background/Queue 双模式 smoke test 通过
6. 文档与代码事实一致

---

## 六、后续候选（下一迭代）

1. Vision 分析历史持久化
2. 子图灰度效果可视化看板
3. 前端关键流程 E2E 套件扩展
4. 通知策略体验优化（阈值 + 静默时段）
